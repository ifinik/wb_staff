# Тестовый фреймворк для модулей на `wb-rules`

## Описание

Этот проект предоставляет тестовый фреймворк для проверки модулей, написанных для использования с `wb-rules` на устройствах Wiren Board. Фреймворк включает два основных компонента:

1. **`test.sh`** — Bash-скрипт для управления запуском `wb-rules`, обработки ошибок и завершения тестов.
2. **`wb-rules-test.js`** — JavaScript-скрипт, реализующий логику проверки модулей по тестовым данным, определённым в файлах формата `JSONC`.
3. **`Dockerfile`** — Docker-образ для выполнения тестов.
4. **`Makefile`** — обертка для docker чтобы запускать одной командой.

Фреймворк позволяет:

- Выполнять тесты функций из модулей `wb-rules`.
- Проверять корректность работы модулей на основе заранее определённых входных данных и ожидаемых результатов.
- Генерировать отчёты о прохождении тестов.

## Структура проекта

```
├── Dockerfile           # Docker-образ для выполнения тестов
├── Makefile             # Утилита для сборки и запуска контейнера
├── test.sh              # Скрипт управления тестами
├── wb-rules-test.js     # Скрипт выполнения тестов
├── mosquitto.conf       # Конфигурационный файл Mosquitto
├── wirenboard.gpg       # Ключ для установки пакетов из репо Wirenboard
├── src/                 # Директория с модулями `wb-rules`
└── tests/               # Директория с тестовыми файлами `JSONC`

```

## Установка и запуск

### Предварительные требования

- Установленный Docker
- Компьютер с поддержкой архитектуры `armhf` или возможность эмуляции платформы ARM

### Шаги для запуска

1. Скопируйте проект на локальный компьютер:

   ```bash
   git clone git@github.com:ifinik/wb_staff.git
   cd wb_staff
   ```

2. Соберите Docker-образ и выполнить тест:

   ```bash
   make
   ```

Контейнер автоматически выполнит тесты и выведет результаты в консоль.

## Структура тестовых файлов

Тесты определяются в формате `JSONC`. Каждый файл содержит описание тестов для одного или нескольких модулей. Пример файла:

```jsonc
{
  "module_name": {
    "function_name": [
      [[arg1, arg2], expected_result],
      [[arg3, arg4], expected_result2]
    ]
  }
}
```

### Поля:

- `module_name` — название модуля, подключаемого через `require`.
- `function_name` — название функции в модуле, которая тестируется.
- `args` — массив аргументов для функции.
- `expected_result` — ожидаемый результат выполнения функции.

Пример:

```jsonc
{
  "exampleModule": {
    "add": [
      [[2, 3], 5],
      [[-1, 1], 0]
    ],
    "multiply": [
      [[2, 3], 6],
      [[-1, -1], 1]
    ]
  }
}
```

## Основные команды

### Makefile

- `make docker_build` — сборка Docker-образа.
- `make docker_run` — запуск тестов в контейнере.

### Bash-скрипт `test.sh`

- Обрабатывает запуск `wb-rules`.
- Следит за ошибками в выводе (`ERROR:` или `FAIL:`).
- Завершает процесс при достижении таймаута или успешном завершении тестов.

### JavaScript-скрипт `wb-rules-test.js`

- Выполняет тесты для модулей, описанных в файлах `JSONC`.
- Логирует успешные и проваленные тесты.

## Результаты выполнения тестов

После запуска тестов выводятся логи, содержащие информацию о прохождении тестов:

- Успешные тесты помечаются как `PASS`.
- Ошибки выводятся с префиксом `FAIL`, включая детальную информацию о причине (например, несоответствие результатов или ошибка исполнения).

Пример вывода:

```plaintext
Processing test file: /etc/tests/example.jsonc
Testing module: exampleModule
Testing function: exampleModule.add
PASS: add
FAIL: multiply => actual: 5, expected: 6
Testing ended
```

## Как добавить свой модуль и тесты

1. Разместите модуль в директории `src/`.
2. Напишите тесты для модуля в формате `JSONC` и сохраните их в директории `tests/`.
3. Пересоберите Docker-образ и запустите тесты:

   ```bash
   make docker_build
   make docker_run
   ```

## Лицензия

Этот проект распространяется под лицензией MIT.
