# Тестовый фреймворк для модулей на `wb-rules`

## Цели проекта

Работа с `wb-rules` для платформы Wiren Board может быть сложной:

- **Редактирование в интерфейсе**: писать сложные модули в интерфейсе неудобно.
- **Тестирование на контроллере**: требует заливки кода, моделирования данных, что занимает много времени.
- **Отсутствие регрессионного тестирования**: при внесении изменений сложно убедиться, что ничего не сломано.

Этот проект решает эти проблемы, предоставляя удобное тестовое окружение:

- **Локальное тестирование**: писать модули в удобной IDE и тестировать их локально.
- **Автоматизация**: запуск тестов одной командой.
- **Быстрая обратная связь**: выполнение тестов занимает всего несколько секунд.
- **Поддержка регрессии**: тесты фиксируют поведение модулей, предотвращая случайные поломки.

Фреймворк вдохновлён подходом Python Doctest и адаптирован под потребности платформы Wiren Board.

---

## Описание

Этот проект предоставляет инструменты для написания и автоматического тестирования модулей `wb-rules`.

Он включает:

1. **`test.sh`** — Bash-скрипт для управления запуском `wb-rules`.
2. **`test_gen.js`** — JavaScript-скрипт для генерации кода тестов по JSDoc вашего модуля.
3. **`Dockerfile`** — окружение для выполнения тестов с поддержкой архитектуры ARM.
4. **`Makefile`** — удобный способ сборки и запуска тестов.

---

## Как это работает?

1. Вы пишете модули для `wb-rules` в папке `src/`.
2. Запускаете тесты `make`.
3. Фреймворк генерирует тесты, сравнивает результаты с ожидаемыми и выводит отчёт.

---

## Пример использования

Допустим, у вас есть модуль `exampleModule.js`:

```javascript
// exampleModule.js
function add(a, b) {
    return a + b;
}

exports.add = add;
```

И вы хотите протестировать его. Для этого перед функцией нужно добавить комментарий
в формате JSDoc с `@example` примерами вызова функции, например так:

```javascript
// exampleModule.js
/**
 * @example
 * add(2, 3) // 5
 * @example
 * add(10, -5) // 5
 */
function add(a, b) {
    return a + b;
}

exports.add = add;
```

Теперь выполните тесты:

```bash
make
```

Результат:

```plaintext
INFO:  [rule info] Start testing exampleModule in file /etc/wb-rules/exampleModule-tests.js
INFO:  [rule info] PASS: Test 1 in exampleModule
INFO:  [rule info] PASS: Test 2 in exampleModule
INFO:  [rule info] PASS: Test 3 in exampleModule
INFO:  [rule info] PASS: Test 4 in exampleModule
INFO:  all rule files are loaded
```

---

## Структура проекта

```
├── Dockerfile           # Docker-образ для выполнения тестов
├── Makefile             # Утилита для сборки и запуска контейнера
├── test.sh              # Скрипт управления тестами
├── test_gen.js          # Скрипт генерации тестов
├── mosquitto.conf       # Конфигурация Mosquitto
├── wirenboard.gpg       # GPG-ключ репозитория Wiren Board
└── src/                 # Директория с модулями `wb-rules`
```

---

## Установка и запуск

### Требования

- Установленный Docker
- Поддержка архитектуры ARM (или её эмуляция)

### Шаги

1. Склонируйте репозиторий:

   ```bash
   git clone git@github.com:ifinik/wb_staff.git
   cd wb_staff
   ```

2. Запустите эмуляцию ARM (если требуется):

   ```bash
   docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
   ```

3. Соберите и выполните тесты:

   ```bash
   make
   ```

Контейнер выполнит тесты и выведет результаты в консоль.

---

## Как добавить модуль и тесты?

1. Поместите ваш модуль в папку `src/` (например, `src/exampleModule.js`).
2. Выполните тесты:

   ```bash
   make
   ```

---

### Makefile

- `make` — сборка образа и запуск тестов.
- `make docker_build` — сборка Docker-образа.
- `make docker_run` — запуск тестов в контейнере.

---

## Преимущества

- **Быстрое тестирование**: полный цикл занимает ~5 секунд.
- **Поддержка регрессии**: вы всегда знаете, что ничего не сломано.
- **IDE-дружественность**: пишите код в любимой IDE, а не в веб-интерфейсе.
- **Минимальная настройка**: готовый Docker-образ с поддержкой ARM.

## FAQ

### Вопрос:

**"Так а зачем эта вся обвязка в виде Wiren Board, Dockerfile и прочего? Можно же просто покрыть функции юнит-тестами, и всё."**

### Ответ:

Обвязка необходима для того, чтобы создать окружение, максимально близкое к реальному контроллеру Wiren Board. Это позволяет:

1. **Эмулировать особенности контроллера**:
   - Объекты, доступные в \`wb-rules\`, приходится мокать вручную, если работать без обвязки.
   - Поддерживать тот же синтаксис и доступные методы, как на устройстве.

2. **Работать с ES6 и современными инструментами**:
   - При написании тестов и кода на локальной машине часто возникают сложности с соблюдением ограничений, присущих контроллеру (например, доступных библиотек и функций).

3. **Унифицировать окружение**:
   - Использование Docker и других инструментов позволяет добиться одинакового поведения кода как на локальной машине, так и на реальном устройстве.

Таким образом, обвязка минимизирует расхождения между разработкой и реальным окружением, что существенно ускоряет процесс тестирования и отладки.
